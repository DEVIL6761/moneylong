{% extends "base.html" %}

{% block content %}
<div class="analytics-container" style="max-width: none; width: 100%; padding: 0 40px;">

    <h1><i class="fas fa-chart-pie"></i> Аналитика финансов</h1>
    <form id="monthForm" method="get" style="text-align: center; margin-bottom: 20px;">
        <label for="monthSelect">Выберите месяц:</label>
        <select name="month" id="monthSelect" onchange="document.getElementById('monthForm').submit()">
            {% for month in months %}
                <option value="{{ month }}" {% if month == selected_month %}selected{% endif %}>{{ month | format_month }}</option>
            {% endfor %}
        </select>
    </form>

    <!-- Секция с гистограммой - теперь первой -->
    <div class="analytics-section">
    <h2>Движение средств по дням — {{ selected_month | format_month }}</h2>
    <div style="width: 100%; max-width: 1000px; height: 500px; margin: 0 auto;">
        <canvas id="dailyChart" style="width: 100%; height: 100%;"></canvas>
    </div>
</div>


    <!-- Остальные секции -->
    <div class="analytics-section">
        <h2>Расходы по категориям — {{ selected_month | format_month }}</h2>
        <div class="chart-container">
            <div class="chart-wrapper">
    <canvas id="expenseChart"></canvas>
    <div class="chart-total" id="expenseTotal"></div>
</div>

        </div>
    </div>

    <div class="analytics-section">
        <h2>Доходы по категориям — {{ selected_month | format_month }}</h2>
        <div class="chart-container">
            <div class="chart-wrapper" style="position: relative;">
                <canvas id="incomeChart"></canvas>
                <div class="chart-total" id="incomeTotal"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
    const textColor = '#dfe6e9';
    const selectedMonth = '{{ selected_month }}';  // формат YYYY-MM
    const dailyStats = {{ daily_stats | tojson }};
    const expenseStats = {{ expense_stats | tojson }};
    const incomeStats = {{ income_stats | tojson }};

    const monthNames = {
        '01': 'январь', '02': 'февраль', '03': 'март', '04': 'апрель',
        '05': 'май', '06': 'июнь', '07': 'июль', '08': 'август',
        '09': 'сентябрь', '10': 'октябрь', '11': 'ноябрь', '12': 'декабрь'
    };

    // ========== Вспомогательные функции ==========
    function generateDaysArray(year, month) {
        const days = [];
        const date = new Date(year, month - 1, 1);
        while (date.getMonth() === month - 1) {
            days.push(date.getDate().toString());
            date.setDate(date.getDate() + 1);
        }
        return days;
    }

    function getValueForDay(day, type) {
        const entry = dailyStats.find(e => e.day === day);
        if (!entry) return 0;
        return entry[type] || 0;
    }

    function createPieChart(canvasId, data, title) {
        const ctx = document.getElementById(canvasId);
        if (!ctx) return;

        const chartData = {
            labels: data.map(item => item.name),
            datasets: [{
                data: data.map(item => item.total),
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                    '#9966FF', '#FF9F40', '#8AC24A', '#607D8B'
                ],
                borderWidth: 1
            }]
        };

        const total = data.reduce((sum, item) => sum + item.total, 0);
        const totalContainer = document.getElementById(canvasId.replace('Chart', 'Total'));
        if (totalContainer) {
            totalContainer.textContent = `${total.toFixed(2)} BYN`;
        }

        new Chart(ctx, {
            type: 'doughnut',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: textColor
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: ctx => {
                                const value = ctx.raw;
                                const percentage = (value / total * 100).toFixed(1);
                                return `${ctx.label}: ${value.toFixed(2)} BYN (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    // ========== Гистограмма по дням ==========
    const [year, month] = selectedMonth.split('-');
    const allDays = generateDaysArray(parseInt(year), parseInt(month));
    const incomeData = allDays.map(day => getValueForDay(day, 'income'));
    const expenseData = allDays.map(day => getValueForDay(day, 'expense'));

    const dailyCtx = document.getElementById('dailyChart');
if (dailyCtx) {
    const textColor = '#dfe6e9';
    const selectedMonth = '{{ selected_month }}';

    // Генерация всех дней месяца
    function generateAllDays(monthStr) {
        const [year, month] = monthStr.split('-').map(Number);
        const daysInMonth = new Date(year, month, 0).getDate();
        const allDays = [];
        for (let day = 1; day <= daysInMonth; day++) {
            allDays.push(String(day).padStart(2, '0'));
        }
        return allDays;
    }

    const allDays = generateAllDays(selectedMonth);
    const rawData = {{ daily_stats | tojson }};
    const incomeMap = {}, expenseMap = {};

    rawData.forEach(item => {
        incomeMap[item.day] = item.income;
        expenseMap[item.day] = item.expense;
    });

    const incomeData = allDays.map(day => incomeMap[day] || 0);
    const expenseData = allDays.map(day => expenseMap[day] || 0);

    new Chart(dailyCtx, {
        type: 'bar',
        data: {
            labels: allDays,
            datasets: [
                {
                    label: 'Доходы',
                    data: incomeData,
                    backgroundColor: '#00b894',
                    borderColor: '#00b894',
                    borderWidth: 1
                },
                {
                    label: 'Расходы',
                    data: expenseData.map(x => -x),
                    backgroundColor: '#d63031',
                    borderColor: '#d63031',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    labels: {
                        color: textColor
                    }
                },
                tooltip: {
                    callbacks: {
                        label: ctx => {
                            const label = ctx.dataset.label;
                            return `${label}: ${Math.abs(ctx.raw).toFixed(2)} BYN`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: { color: textColor },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                y: {
                    ticks: {
                        color: textColor,
                        callback: value => Math.abs(value) + ' BYN'
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}

    // ========== Круговые диаграммы ==========
    createPieChart('expenseChart', expenseStats, 'Расходы по категориям');
    createPieChart('incomeChart', incomeStats, 'Доходы по категориям');
});


</script>
{% endblock %}