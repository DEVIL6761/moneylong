{% extends "base.html" %}

{% block content %}
<div class="analytics-container">
    <h1><i class="fas fa-chart-pie"></i> Аналитика финансов</h1>

    <div class="analytics-section">
        <h2>Расходы по категориям</h2>
        <div class="chart-container">
            <div class="chart-wrapper">
                <canvas id="expenseChart"></canvas>
                <div class="chart-total" id="expenseTotal"></div>
            </div>
        </div>
    </div>

    <div class="analytics-section">
        <h2>Доходы по категориям</h2>
        <div class="chart-container">
            <div class="chart-wrapper">
                <canvas id="incomeChart"></canvas>
                <div class="chart-total" id="incomeTotal"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Основной цвет текста (как у общей суммы)
        const textColor = '#dfe6e9';

        const calculatePercentages = (data) => {
            const total = data.reduce((sum, item) => sum + item.total, 0);
            return {
                data: data.map(item => ({
                    ...item,
                    percentage: (item.total / total * 100).toFixed(1)
                })),
                total: total
            };
        };

        const expenseChartData = calculatePercentages({{ expense_stats|tojson }});
        const incomeChartData = calculatePercentages({{ income_stats|tojson }});

        createChart('expenseChart', expenseChartData, textColor);
        createChart('incomeChart', incomeChartData, textColor);

            function createChart(canvasId, chartData, textColor) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        const totalElement = document.getElementById(canvasId.replace('Chart', 'Total'));

        // Общая сумма сдвинута влево (35%) и валюта BYN
        totalElement.textContent = `${chartData.total.toFixed(2)} BYN`; // Изменено на BYN
        totalElement.style.left = '35%'; // Сильнее сдвигаем влево

            const chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: chartData.data.map(item => item.name),
                    datasets: [{
                        data: chartData.data.map(item => item.total),
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                            '#9966FF', '#FF9F40', '#8AC24A', '#607D8B'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: textColor // Цвет текста категорий как у общей суммы
                            }
                        },
                        tooltip: {
                        callbacks: {
                            label: function(context) {
                                const percentage = chartData.data[context.dataIndex].percentage;
                                return `${context.label}: ${context.raw.toFixed(2)} BYN (${percentage}%)`; // BYN вместо ₽
                                }
                            }
                        }
                    },
                    animation: {
                        animateScale: true,
                        animateRotate: true
                    }
                }
            });

            // Добавляем проценты на диаграмму
            chart.update();
            chartData.data.forEach((item, index) => {
                if (item.percentage > 10) {
                    const arc = chart.getDatasetMeta(0).data[index];
                    if (arc) {
                        const {x, y} = arc.tooltipPosition();
                        ctx.font = 'bold 12px Arial';
                        ctx.fillStyle = textColor; // Цвет процентов как у общей суммы
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(`${item.percentage}%`, x, y);
                    }
                }
            });
        }
    });
</script>
{% endblock %}